const STORAGE_KEY = 'membersData';

export const members = [
  {
    id: 1,
    name: '권동희',
    englishName: 'DongheeKwon',
    github: 'hamxxn',
    gender: 'female',
    role: 'OB',
    codeReviewGroup: 1,
    age: 23,
  },
  {
    id: 2,
    name: '김어진',
    englishName: 'EojinKim',
    github: 'eojindesu',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 2,
    age: 24,
  },
  {
    id: 3,
    name: '김윤지',
    englishName: 'YoonjiKim',
    github: 'yooncandooit',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 7,
    age: 21,
  },
  {
    id: 4,
    name: '민경빈',
    englishName: 'GyeongBinMin',
    github: 'gyeongbibin',
    gender: 'male',
    role: 'YB',
    codeReviewGroup: 6,
    age: 25,
  },
  {
    id: 5,
    name: '박소현',
    englishName: 'SohyunPark',
    github: 'Sohyunnnn',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 8,
    age: 24,
  },
  {
    id: 6,
    name: '박원',
    englishName: 'WonPark',
    github: 'wonpark1',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 7,
    age: 22,
  },
  {
    id: 7,
    name: '박진석',
    englishName: 'JinSeokPark',
    github: 'jin-evergreen',
    gender: 'male',
    role: 'YB',
    codeReviewGroup: 3,
    age: 23,
  },
  {
    id: 8,
    name: '배정민',
    englishName: 'JeongminBae',
    github: 'qowjdals23',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 4,
    age: 24,
  },
  {
    id: 9,
    name: '백지연',
    englishName: 'JiyeonBaek',
    github: 'jyeon03',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 3,
    age: 23,
  },
  {
    id: 10,
    name: '손하은',
    englishName: 'HaeunSon',
    github: 'sonnnnhe',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 8,
    age: 23,
  },
  {
    id: 11,
    name: '송민하',
    englishName: 'MinhaSong',
    github: 'sminha',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 5,
    age: 26,
  },
  {
    id: 12,
    name: '양승혜',
    englishName: 'SeunghyeYang',
    github: 'seunghye-rain',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 1,
    age: 26,
  },
  {
    id: 13,
    name: '엄경호',
    englishName: 'KyounghoEom',
    github: 'maehwasoo',
    gender: 'male',
    role: 'OB',
    codeReviewGroup: 1,
    age: 28,
  },
  {
    id: 14,
    name: '오다운',
    englishName: 'DownOh',
    github: 'downddown',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 2,
    age: 22,
  },
  {
    id: 15,
    name: '유지민',
    englishName: 'JiminYoo',
    github: 'Yoojimin28',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 1,
    age: 23,
  },
  {
    id: 16,
    name: '이동현',
    englishName: 'DonghyunLee',
    github: 'clover-4022',
    gender: 'male',
    role: 'OB',
    codeReviewGroup: 7,
    age: 27,
  },
  {
    id: 17,
    name: '이훈진',
    englishName: 'HunjinLee',
    github: 'huniversal',
    gender: 'male',
    role: 'YB',
    codeReviewGroup: 4,
    age: 25,
  },
  {
    id: 18,
    name: '임나은',
    englishName: 'NaeunLim',
    github: 'eunkr82',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 2,
    age: 22,
  },
  {
    id: 19,
    name: '임서준',
    englishName: 'SeojoonLim',
    github: 'jm8468',
    gender: 'male',
    role: 'YB',
    codeReviewGroup: 1,
    age: 26,
  },
  {
    id: 20,
    name: '임지성',
    englishName: 'JisungLim',
    github: 'jstar000',
    gender: 'male',
    role: 'OB',
    codeReviewGroup: 2,
    age: 26,
  },
  {
    id: 21,
    name: '임지수',
    englishName: 'JisooLim',
    github: 'jisooooooooooo',
    gender: 'female',
    role: 'OB',
    codeReviewGroup: 3,
    age: 25,
  },
  {
    id: 22,
    name: '장민수',
    englishName: 'MinsuJang',
    github: 'Tnalxmsk',
    gender: 'male',
    role: 'YB',
    codeReviewGroup: 8,
    age: 27,
  },
  {
    id: 23,
    name: '장정훈',
    englishName: 'JeonghoonJang',
    github: 'jeonghoon11',
    gender: 'male',
    role: 'OB',
    codeReviewGroup: 5,
    age: 25,
  },
  {
    id: 24,
    name: '정유진',
    englishName: 'YujinJung',
    github: 'hello-yujin',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 5,
    age: 23,
  },
  {
    id: 25,
    name: '조혜린',
    englishName: 'HyerinCho',
    github: 'jogpfls',
    gender: 'female',
    role: 'OB',
    codeReviewGroup: 6,
    age: 22,
  },
  {
    id: 26,
    name: '지민재',
    englishName: 'MinjaeJi',
    github: 'mimizae',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 6,
    age: 23,
  },
  {
    id: 27,
    name: '차주영',
    englishName: 'JuyoungCha',
    github: 'verynicetomato',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 3,
    age: 24,
  },
  {
    id: 28,
    name: '최윤하',
    englishName: 'YoonhaChoi',
    github: 'twossu',
    gender: 'female',
    role: 'YB',
    codeReviewGroup: 7,
    age: 23,
  },
];

const seedMembers = () => {
  if (!localStorage.getItem(STORAGE_KEY)) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(members));
  }
};

export const getMembers = () => {
  const stored = localStorage.getItem(STORAGE_KEY);
  if (!stored) return [];
  try {
    const parsed = JSON.parse(stored);
    return Array.isArray(parsed) ? parsed : [];
  } catch (error) {
    console.error('Failed to parse members from storage', error);
    return [];
  }
};

const genderLabel = {
  female: '여자',
  male: '남자',
};

const renderMembers = (list = []) => {
  const tableBody = document.getElementById('member-table-body');
  const selectAll = document.getElementById('select-all');
  const deleteButton = document.getElementById('delete-selected');
  if (!tableBody) return;

  tableBody.innerHTML = '';

  if (!list.length) {
    if (selectAll) selectAll.checked = false;
    if (deleteButton) deleteButton.disabled = true;

    const emptyRow = document.createElement('tr');
    emptyRow.className = 'list-table__empty-row';
    const emptyCell = document.createElement('td');
    emptyCell.colSpan = 8;
    emptyCell.className = 'list-table__empty';
    emptyCell.textContent = '목록이 비어 있습니다.';
    emptyRow.appendChild(emptyCell);
    tableBody.appendChild(emptyRow);
    return;
  }

  list.forEach((member) => {
    const row = document.createElement('tr');
    row.dataset.memberId = String(member.id ?? '');

    const checkboxCell = document.createElement('td');
    checkboxCell.className = 'list-table__cell--checkbox';
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.setAttribute('aria-label', `${member.name ?? '멤버'} 선택`);
    checkbox.className = 'member-checkbox';
    checkboxCell.appendChild(checkbox);
    row.appendChild(checkboxCell);

    const createTextCell = (value) => {
      const cell = document.createElement('td');
      cell.textContent = value ?? '-';
      return cell;
    };

    row.appendChild(createTextCell(member.name ?? '-'));
    row.appendChild(createTextCell(member.englishName ?? '-'));

    const githubCell = document.createElement('td');
    if (member.github) {
      const link = document.createElement('a');
      link.href = `https://github.com/${member.github}`;
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.className = 'list-table__link';
      link.textContent = member.github;
      githubCell.appendChild(link);
    } else {
      githubCell.textContent = '-';
    }
    row.appendChild(githubCell);

    row.appendChild(createTextCell(genderLabel[member.gender] ?? member.gender ?? '-'));
    row.appendChild(createTextCell(member.role ?? '-'));
    row.appendChild(createTextCell(
      member.codeReviewGroup !== undefined && member.codeReviewGroup !== null
        ? String(member.codeReviewGroup)
        : '-',
    ));
    row.appendChild(createTextCell(
      member.age !== undefined && member.age !== null ? String(member.age) : '-',
    ));

    tableBody.appendChild(row);
  });
  syncSelectionState();
};

const syncSelectionState = () => {
  const selectAll = document.getElementById('select-all');
  const deleteButton = document.getElementById('delete-selected');
  const checkboxes = Array.from(document.querySelectorAll('.member-checkbox'));

  const hasMembers = checkboxes.length > 0;
  const checkedCount = checkboxes.filter((checkbox) => checkbox.checked).length;

  if (selectAll) {
    selectAll.checked = hasMembers && checkedCount === checkboxes.length;
    selectAll.indeterminate = false;
  }

  if (deleteButton) {
    deleteButton.disabled = checkedCount === 0;
  }
};

const attachEventListeners = () => {
  const tableBody = document.getElementById('member-table-body');
  const selectAll = document.getElementById('select-all');
  const deleteButton = document.getElementById('delete-selected');
  const modalForm = document.querySelector('.modal-form');

  if (tableBody) {
    tableBody.addEventListener('change', (event) => {
      if (event.target && event.target.classList.contains('member-checkbox')) {
        syncSelectionState();
      }
    });
  }

  if (selectAll) {
    selectAll.addEventListener('change', () => {
      const checkboxes = document.querySelectorAll('.member-checkbox');
      checkboxes.forEach((checkbox) => {
        checkbox.checked = selectAll.checked;
      });
      syncSelectionState();
    });
  }

  if (deleteButton) {
    deleteButton.addEventListener('click', handleDeleteSelected);
  }

  if (modalForm) {
    modalForm.addEventListener('submit', handleAddMember);
  }
};

const handleDeleteSelected = () => {
  const stored = getMembers();
  const selectedIds = Array.from(document.querySelectorAll('.member-checkbox'))
    .filter((checkbox) => checkbox.checked)
    .map((checkbox) => Number(checkbox.closest('tr')?.dataset.memberId));

  if (!selectedIds.length) return;

  const nextMembers = stored.filter((member) => !selectedIds.includes(member.id));
  localStorage.setItem(STORAGE_KEY, JSON.stringify(nextMembers));
  renderMembers(nextMembers);
  syncSelectionState();
};

const handleAddMember = (event) => {
  event.preventDefault();

  const form = event.currentTarget;
  const formData = new FormData(form);

  const name = formData.get('modal-name')?.toString().trim();
  const englishName = formData.get('modal-english-name')?.toString().trim();
  const github = formData.get('modal-github')?.toString().trim();
  const gender = formData.get('modal-gender')?.toString();
  const role = formData.get('modal-role')?.toString();
  const team = formData.get('modal-team')?.toString().trim();
  const ageValue = formData.get('modal-age')?.toString().trim();

  if (!name || !englishName || !github || !gender || !role || !team || !ageValue) {
    alert('모든 항목을 입력해주세요.');
    return;
  }

  const age = Number(ageValue);
  const codeReviewGroup = Number(team);

  if (Number.isNaN(age) || Number.isNaN(codeReviewGroup)) {
    alert('금잔디조와 나이는 숫자로 입력해주세요.');
    return;
  }

  const stored = getMembers();
  const nextId = stored.reduce((max, member) => Math.max(max, member.id ?? 0), 0) + 1;

  const newMember = {
    id: nextId,
    name,
    englishName,
    github,
    gender,
    role,
    codeReviewGroup,
    age,
  };

  const nextMembers = [...stored, newMember];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(nextMembers));
  renderMembers(nextMembers);
  syncSelectionState();

  form.reset();
  closeModal();
};

const closeModal = () => {
  const modal = document.getElementById('member-modal');
  if (!modal) return;
  const closeButton = modal.querySelector('[data-modal-close]');
  if (closeButton instanceof HTMLButtonElement) {
    closeButton.click();
  } else {
    modal.hidden = true;
    document.body.removeAttribute('data-modal-open');
  }
};

document.addEventListener('DOMContentLoaded', () => {
  seedMembers();
  const currentMembers = getMembers();
  renderMembers(currentMembers);
  attachEventListeners();
});
